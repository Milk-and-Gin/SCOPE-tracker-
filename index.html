<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modern Magik Ritual Tracker</title>
  <!-- Link the app icon (JPEG will be resized automatically by the OS) -->
  <link rel="icon" type="image/jpeg" sizes="192x192" href="9114919B-E126-4262-A8E6-0EED272FEF37.jpeg">
  <link rel="apple-touch-icon" href="9114919B-E126-4262-A8E6-0EED272FEF37.jpeg">
  <!-- Reference the inline manifest -->
  <link rel="manifest" href="#manifest">
  <!-- Set the address bar color on mobile -->
  <meta name="theme-color" content="#58318b">
  <style>
    /* Brutalist‑inspired styling: neutral palette, simple geometry, strong typography */
    :root {
      --bg-color:     #f3f3f3;
      --surface-color:#ffffff;
      --border-color: #d0d0d0;
      --text-color:   #1f1f1f;
      --muted-color:  #666666;
      --accent-color: #58318b;
    }
    body {
      margin: 0;
      padding-bottom: 6rem; /* space for the floating button */
      background: var(--bg-color);
      color: var(--text-color);
      font-family: "Roboto Mono", monospace;
      line-height: 1.5;
    }
    header {
      background: var(--surface-color);
      border-bottom: 4px solid var(--border-color);
      padding: 2rem 1rem 1rem;
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: 2rem;
      font-weight: 700;
      text-transform: uppercase;
    }
    header h2 {
      margin: 0.3rem 0 0;
      font-size: 1.1rem;
      font-weight: 500;
      color: var(--muted-color);
      text-transform: uppercase;
    }
    main {
      max-width: 900px;
      margin: 0 auto;
      padding: 1rem;
    }
    .card {
      background: var(--surface-color);
      border: 2px solid var(--border-color);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .card h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.2rem;
      font-weight: 700;
      text-transform: uppercase;
    }
    label {
      display: flex;
      flex-direction: column;
      margin-bottom: 1rem;
      font-weight: 600;
      font-size: 0.9rem;
    }
    label span {
      margin-bottom: 0.25rem;
    }
    input[type="text"],
    input[type="date"],
    textarea {
      padding: 0.5rem;
      border: 2px solid var(--border-color);
      background: var(--surface-color);
      font-family: inherit;
      font-size: 0.9rem;
      color: var(--text-color);
    }
    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 1rem;
      background: var(--border-color);
      margin-top: 0.25rem;
      border-radius: 0;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 1.2rem;
      width: 1.2rem;
      background: var(--accent-color);
      border: none;
      margin-top: -0.1rem;
    }
    input[type="range"]::-webkit-slider-runnable-track {
      height: 1rem;
      background: var(--border-color);
    }
    .range-value {
      font-size: 0.75rem;
      margin-top: 0.25rem;
      color: var(--muted-color);
    }
    .output-row {
      margin-bottom: 1rem;
    }
    .output-bar {
      position: relative;
      width: 100%;
      height: 2rem; /* bigger bar for visibility */
      background: var(--border-color);
    }
    .output-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0%;
      background: var(--accent-color);
      transition: width 0.3s ease;
    }
    .output-value {
      font-size: 0.8rem;
      margin-top: 0.25rem;
      color: var(--muted-color);
      text-align: right;
    }
    .btn-row {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }
    button {
      flex: 1;
      padding: 0.8rem;
      font-size: 0.9rem;
      font-weight: 700;
      text-transform: uppercase;
      border: none;
      cursor: pointer;
      color: #fff;
    }
    #save    { background: var(--accent-color); }
    #download{ background: var(--text-color); }
    .floating-link {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent-color);
      color: #fff;
      padding: 0.7rem 1.4rem;
      text-decoration: none;
      font-weight: 700;
      font-size: 0.9rem;
      opacity: 0.65;
      transition: opacity 0.3s;
      z-index: 1000;
    }
    .floating-link:hover {
      opacity: 1;
    }
  </style>
</head>
<body>
  <header>
    <h1>Modern Magik</h1>
    <h2>Ritual Tracker</h2>
  </header>
  <main>
    <form id="scope-form">
      <!-- Meta Section -->
      <div class="card">
        <h3>Meta</h3>
        <label><span>Date</span><input type="date" id="date"></label>
        <label><span>Location</span><input type="text" id="location"></label>
        <label><span>Tradition</span><input type="text" id="tradition"></label>
        <label><span>Goal</span><input type="text" id="goal"></label>
      </div>
      <!-- Inputs Section -->
      <div class="card">
        <h3>Inputs (0–1 scale)</h3>
        <label><span>Attention A</span><input type="range" id="aFocus" min="0" max="1" step="0.25" value="0"><span class="range-value" id="aFocusVal">0.00</span></label>
        <label><span>Belief B</span><input type="range" id="bBelief" min="0" max="1" step="0.25" value="0"><span class="range-value" id="bBeliefVal">0.00</span></label>
        <label><span>Attachment D</span><input type="range" id="dAttach" min="0" max="1" step="0.25" value="0"><span class="range-value" id="dAttachVal">0.00</span></label>
        <label><span>Resistance R</span><input type="range" id="rRes" min="0" max="1" step="0.25" value="0"><span class="range-value" id="rResVal">0.00</span></label>
        <label><span>Skill S</span><input type="range" id="sSkill" min="0" max="1" step="0.25" value="0"><span class="range-value" id="sSkillVal">0.00</span></label>
        <label><span>Link L</span><input type="range" id="lLink" min="0" max="1" step="0.25" value="0"><span class="range-value" id="lLinkVal">0.00</span></label>
        <label><span>Representation Rr</span><input type="range" id="rRepr" min="0" max="1" step="0.25" value="0"><span class="range-value" id="rReprVal">0.00</span></label>
        <label><span>Coordination C</span><input type="range" id="cCoord" min="0" max="1" step="0.25" value="0"><span class="range-value" id="cCoordVal">0.00</span></label>
        <label><span>Vitality V</span><input type="range" id="vVitality" min="0" max="1" step="0.25" value="0"><span class="range-value" id="vVitalityVal">0.00</span></label>
        <label><span>Noise Q</span><input type="range" id="qNoise" min="0" max="1" step="0.25" value="1"><span class="range-value" id="qNoiseVal">1.00</span></label>
      </div>
      <!-- Outputs Section -->
      <div class="card">
        <h3>Outputs</h3>
        <div class="output-row">
          <div class="output-label">Ψ (efficacy)</div>
          <div class="output-bar"><div class="output-fill" id="psiBar"></div></div>
          <div class="output-value" id="psiVal">0.000</div>
        </div>
        <div class="output-row">
          <div class="output-label">P* (enchanted probability)</div>
          <div class="output-bar"><div class="output-fill" id="pStarBar"></div></div>
          <div class="output-value" id="pStarVal">0.500</div>
        </div>
        <div class="btn-row">
          <button type="submit" id="save">Save Entry</button>
          <button type="button" id="download">Download Latest</button>
        </div>
      </div>
    </form>
    <p id="status"></p>
  </main>
  <a class="floating-link" href="https://www.milkandgin.co.uk/scope" target="_blank">Read More About SCOPE</a>

  <!-- Inline PWA manifest -->
  <script id="manifest" type="application/manifest+json">
  {
    "name": "Modern Magik Ritual Tracker",
    "short_name": "Magik",
    "start_url": ".",
    "display": "standalone",
    "background_color": "#f3f3f3",
    "theme_color": "#58318b",
    "icons": [
      {
        "src": "9114919B-E126-4262-A8E6-0EED272FEF37.jpeg",
        "sizes": "192x192",
        "type": "image/jpeg",
        "purpose": "maskable any"
      },
      {
        "src": "9114919B-E126-4262-A8E6-0EED272FEF37.jpeg",
        "sizes": "512x512",
        "type": "image/jpeg"
      }
    ]
  }
  </script>

  <script>
    // Element references
    const inputs = {
      aFocus: document.getElementById('aFocus'),
      bBelief: document.getElementById('bBelief'),
      dAttach: document.getElementById('dAttach'),
      rRes: document.getElementById('rRes'),
      sSkill: document.getElementById('sSkill'),
      lLink: document.getElementById('lLink'),
      rRepr: document.getElementById('rRepr'),
      cCoord: document.getElementById('cCoord'),
      vVitality: document.getElementById('vVitality'),
      qNoise: document.getElementById('qNoise')
    };
    const spans = {
      aFocusVal: document.getElementById('aFocusVal'),
      bBeliefVal: document.getElementById('bBeliefVal'),
      dAttachVal: document.getElementById('dAttachVal'),
      rResVal: document.getElementById('rResVal'),
      sSkillVal: document.getElementById('sSkillVal'),
      lLinkVal: document.getElementById('lLinkVal'),
      rReprVal: document.getElementById('rReprVal'),
      cCoordVal: document.getElementById('cCoordVal'),
      vVitalityVal: document.getElementById('vVitalityVal'),
      qNoiseVal: document.getElementById('qNoiseVal')
    };
    const psiBar   = document.getElementById('psiBar');
    const pStarBar = document.getElementById('pStarBar');
    const psiVal   = document.getElementById('psiVal');
    const pStarVal = document.getElementById('pStarVal');
    const status   = document.getElementById('status');

    // Compute efficacy and probability, scale for display
    function compute() {
      const A = parseFloat(inputs.aFocus.value) || 0;
      const B = parseFloat(inputs.bBelief.value) || 0;
      const D = parseFloat(inputs.dAttach.value) || 0;
      const R = parseFloat(inputs.rRes.value) || 0;
      const S = parseFloat(inputs.sSkill.value) || 0;
      const L = parseFloat(inputs.lLink.value) || 0;
      const Rp= parseFloat(inputs.rRepr.value) || 0;
      const C = parseFloat(inputs.cCoord.value) || 0;
      const V = parseFloat(inputs.vVitality.value) || 0;
      const Q = parseFloat(inputs.qNoise.value) || 0;

      // Multiply factors
      const H = A * B * (1 - D) * (1 - R);
      const X = S * L * Rp * C;
      const Psi = H * X * V * Q;
      const baseline = 0.5;
      const PStar = baseline + (1 - baseline) * Psi;

      const psiClamped   = Math.max(0, Math.min(1, Psi));
      const pStarClamped = Math.max(0, Math.min(1, PStar));

      // Linear scaling: Psi ×10 and P* deviation ×5 for clear visual movement
      const psiDisplay   = Math.min(psiClamped * 10, 1);
      const pStarDisplay = Math.min(baseline + (pStarClamped - baseline) * 5, 1);

      psiBar.style.width   = (psiDisplay  * 100) + '%';
      pStarBar.style.width = (pStarDisplay * 100) + '%';

      psiVal.textContent   = psiClamped.toFixed(3);
      pStarVal.textContent = pStarClamped.toFixed(3);

      return { Psi: psiClamped, PStar: pStarClamped };
    }

    // Update numeric slider values
    function updateDisplay() {
      spans.aFocusVal.textContent    = parseFloat(inputs.aFocus.value).toFixed(2);
      spans.bBeliefVal.textContent   = parseFloat(inputs.bBelief.value).toFixed(2);
      spans.dAttachVal.textContent   = parseFloat(inputs.dAttach.value).toFixed(2);
      spans.rResVal.textContent      = parseFloat(inputs.rRes.value).toFixed(2);
      spans.sSkillVal.textContent    = parseFloat(inputs.sSkill.value).toFixed(2);
      spans.lLinkVal.textContent     = parseFloat(inputs.lLink.value).toFixed(2);
      spans.rReprVal.textContent     = parseFloat(inputs.rRepr.value).toFixed(2);
      spans.cCoordVal.textContent    = parseFloat(inputs.cCoord.value).toFixed(2);
      spans.vVitalityVal.textContent = parseFloat(inputs.vVitality.value).toFixed(2);
      spans.qNoiseVal.textContent    = parseFloat(inputs.qNoise.value).toFixed(2);
    }

    // Persist latest entry in localStorage
    function updateLatestEntry() {
      const { Psi, PStar } = compute();
      const entry = {
        date: document.getElementById('date').value,
        location: document.getElementById('location').value,
        tradition: document.getElementById('tradition').value,
        goal: document.getElementById('goal').value,
        A:  parseFloat(inputs.aFocus.value)   || 0,
        B:  parseFloat(inputs.bBelief.value)  || 0,
        D:  parseFloat(inputs.dAttach.value)  || 0,
        R:  parseFloat(inputs.rRes.value)     || 0,
        S:  parseFloat(inputs.sSkill.value)   || 0,
        L:  parseFloat(inputs.lLink.value)    || 0,
        Rp: parseFloat(inputs.rRepr.value)    || 0,
        C:  parseFloat(inputs.cCoord.value)   || 0,
        V:  parseFloat(inputs.vVitality.value)|| 0,
        Q:  parseFloat(inputs.qNoise.value)   || 0,
        Psi,
        PStar,
        ts: new Date().toISOString()
      };
      localStorage.setItem('modernMagikLatest', JSON.stringify(entry));
    }

    // Reload last saved values
    function loadLatestEntry() {
      const data = localStorage.getItem('modernMagikLatest');
      if (data) {
        try {
          const entry = JSON.parse(data);
          document.getElementById('date').value     = entry.date || '';
          document.getElementById('location').value = entry.location || '';
          document.getElementById('tradition').value= entry.tradition || '';
          document.getElementById('goal').value     = entry.goal || '';
          inputs.aFocus.value    = entry.A || 0;
          inputs.bBelief.value   = entry.B || 0;
          inputs.dAttach.value   = entry.D || 0;
          inputs.rRes.value      = entry.R || 0;
          inputs.sSkill.value    = entry.S || 0;
          inputs.lLink.value     = entry.L || 0;
          inputs.rRepr.value     = entry.Rp || 0;
          inputs.cCoord.value    = entry.C || 0;
          inputs.vVitality.value= entry.V || 0;
          inputs.qNoise.value    = entry.Q || 0;
        } catch (e) {
          console.error('Error loading entry:', e);
        }
      }
    }

    // Save entry to history
    function saveEntry() {
      updateLatestEntry();
      const entry = JSON.parse(localStorage.getItem('modernMagikLatest'));
      const existing = JSON.parse(localStorage.getItem('modernMagikEntries') || '[]');
      existing.push(entry);
      localStorage.setItem('modernMagikEntries', JSON.stringify(existing));
      status.textContent = 'Entry saved.';
      setTimeout(() => { status.textContent = ''; }, 2000);
    }

    // Download latest entry
    function downloadLatest() {
      let latest = localStorage.getItem('modernMagikLatest');
      if (!latest) {
        updateLatestEntry();
        latest = localStorage.getItem('modernMagikLatest');
      }
      const blob = new Blob([latest], { type: 'application/json' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href     = url;
      a.download = 'modern-magik-latest.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      status.textContent = 'File downloaded.';
      setTimeout(() => { status.textContent = ''; }, 2000);
    }

    // Event listeners
    Object.values(inputs).forEach(el => {
      el.addEventListener('input', () => {
        updateDisplay();
        updateLatestEntry();
        compute();
      });
    });
    document.getElementById('scope-form').addEventListener('submit', e => {
      e.preventDefault();
      saveEntry();
    });
    document.getElementById('download').addEventListener('click', downloadLatest);

    // Initialise on load: restore previous entry and compute
    loadLatestEntry();
    updateDisplay();
    compute();
    updateLatestEntry();
  </script>
</body>
</html>